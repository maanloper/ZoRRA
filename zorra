#!/bin/bash
set -e


## TODO: ALWAYS set on run (only needed once), not in script, just show in menu, but only on --install as options as after not needed
DISKNAME="sda"								# Enter the disk name only (sda, sdb, nvme1, etc)
PASSPHRASE="strongpassword"					# Encryption passphrase for "${POOLNAME}"
HOSTNAME="notdroppi"						# Hostname of the installed OS
USERNAME="droppi"							# Username for the user on the installed OS
PASSWORD="password"							# Password for the user on the installed OS
RELEASE="noble"								# Short name of the release to install (e.g. noble)


## Default general settings
root_pool_name="zroot"										# ZFS on Root pool name
zbm_timeout="-1"											# Timeout before ZBM boots default OS [zbm.timeout=0 -> zbm.skip, zbm.timeout=-1 -> zbm.show]
refind_timeout="3"											# Timeout before rEFInd boots latest ZBM image

## Default install settings
INSTALL_DATASET="ubuntu_server_${RELEASE}"	# Set dataset name to install ubuntu server to
LOCALE="en_US.UTF-8"						# New install language setting
TIMEZONE="UTC"								# New install timezone setting
BOOTSIZE="512m"								# Size of boot partition
SWAPSIZE="4G"								# Size of swap partition
POOLNAME="${root_pool_name}"				#TODO teplace POOLNAME everywhere with root_pool_name


## Default manager settings
remote_access_dhcp="dhcp,dhcp6"								# Set which DHCP versions to use
remote_access_hostname="zbm"								# Set hostname when booted as ZFS Boot Menu TODO: DOES THIS WORK??
refind_theme="https://github.com/maanloper/darkmini.git"	# Default rEFInd theme
refind_theme_config="darkmini/theme-mini.conf"				# Default rEFInd theme config



###########################################################################################################
###########################################################################################################

## Initialize menu variables
debootstrap_install=false
add_authorized_key=false
clear_authorized_keys=false
setup_remote_access=false
recreate_dropbear_host_keys=false
set_zbm_timeout=false
set_refind_timeout=false
set_refind_theme=false
auto_unlock_pool=false

trap 'if [ $? -eq 1 ]; then
	cat <<-EOF

		ZoRRA options:
		--debootstrap-install
		--setup-remote-access [--recreate-host-keys]
		--add-authorized-key (add:<public_ssh_key> | user:<user>)
		--clear-authorized-keys
		--set-zbm-timeout [<integer> | 0 (equals zbm.skip) | -1 (equals zbm.show)]
		--set-refind-timeout [<integer>]
		--set-refind-theme [<https//..theme.git> <themename/configname.conf>]
		--auto-unlock-pool (<poolname>)

	EOF
fi' EXIT

## Loop through arguments
if [[ $# -eq 0 ]]; then exit 1; fi
while [[ $# -gt 0 ]]; do
	case "$1" in
		--debootstrap-install)
            debootstrap_install=true
		;;
		--setup-remote-access)
			setup_remote_access=true
		;;
		--recreate-host-keys)
			recreate_dropbear_host_keys=true
		;;
		--set-zbm-timeout)
			set_zbm_timeout=true
			if [[ -z "${2}" || "${2}" == --* ]]; then
				true # use defaults
			elif  [[ "${2}" =~ ^[-]?[0-9]+$ ]]; then
				zbm_timeout="${2}"
				shift
			else
				echo "Missing/wrong input parameter '${2}' for ${1}"
				exit 1
			fi
		;;
		--set-refind-timeout)
			set_refind_timeout=true
			if [[ -z "${2}" || "${2}" == --*  ]]; then
				true # use defaults
			elif  [[ "${2}" =~ ^[0-9]+$ ]]; then
				refind_timeout="${2}"
				shift
			else
				echo "Missing/wrong input parameter '${2}' for ${1}"
				exit 1
			fi
		;;
		--clear-authorized-keys)
			clear_authorized_keys=true
		;;
		--add-authorized-key)
			add_authorized_key=true
			ssh_user=""
			ssh_authorized_key=""
			if [[ "${2}" == add:* && "${2#*:}" != "" ]]; then
				ssh_authorized_key="${2#*:}"
			elif [[ "${2}" == user:* ]]; then
				ssh_user="${2#*:}"
				if ! id "${ssh_user}" &>/dev/null; then
					echo "User '${ssh_user}' does not exist."
					exit 1
				fi
			else
				echo "Missing/wrong input parameter '${2}' for ${1}"
				exit 1
			fi
			shift
		;;
		--auto-unlock-pool)
			auto_unlock_pool=true
			auto_unlock_pool_name=""
			if  [[ -n "${2}" && "${2}" != --* ]]; then
				auto_unlock_pool_name="$2"
			else
				echo "Missing/wrong input parameter '${2}' for ${1}"
				exit 1
			fi
			shift
		;;
		--set-refind-theme)
			set_refind_theme=true
			if [[ -z "${2}" || "${2}" == --* ]]; then
				true # use defaults
			elif grep -q "git" <<< "${2}" && [[ -n "${3}" && "${3}" != --* ]]; then
				refind_theme="${2}"
				refind_theme_config="${3}"
				shift 2
			elif [[ "${2}" == "none" ]]; then
				refind_theme="none"
				shift 1
			else
				echo "Missing/wrong input parameters '${2}' and '${3}' for ${1}"
				exit 1
			fi
		;;
		*)
			echo "Missing/wrong input parameter '${1}' for ${0}"
			exit 1
		;;
	esac
	shift
done

## General settings
dropbear_authorized_keys="/etc/dropbear/authorized_keys"	# Location to save dropbear authorized_keys file - can be changed without breaking installation
keyfile="/etc/zfs/key/zfsroot.key"							# Keyfile - do not change this as it might break your installation!

## Load scripts
echo; echo "ZoRRA: ZFS on Root | Remote Access"
source ./zorra_install.sh
source ./zorra_manager.sh